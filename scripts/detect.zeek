module CVE_2021_31166;

export {
    global signature: pattern = /,\ +?,/;
    redef enum Notice::Type += { CVE_2021_31166 }; 
}

event http_header(c: connection, is_orig: bool, name: string, value: string) {
    if (!is_orig) return;
    if (name != "ACCEPT-ENCODING") return;
    if (CVE_2021_31166::signature !in value) return; 

    NOTICE([$note=CVE_2021_31166::CVE_2021_31166,
        $conn=c,
        $identifier=cat(c$id$orig_h,c$id$resp_h),
        $suppress_for=3600sec,
        $msg="Potential IIS HTTP Protocol Stack CVE-2021-31166 exploit attempt. POC https://github.com/0vercl0k/CVE-2021-31166",
        $sub=fmt("The ACCEPT-ENCODING Header value (max 200 chars shown) is '%s' ", sub_bytes(value,0,200))]);
}